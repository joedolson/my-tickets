<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: mt-ajax.php - My Tickets Hook Doumentation</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="styles-docs.css?v=0.1.1">
</head>

<body>

<div id="main">

    <header><h1 class="page-title">Source: mt-ajax.php</h1></header>
	<main>
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>&lt;?php
/**
 * AJAX handlers for add to cart &amp; cart processing.
 *
 * @category Core
 * @package  My Tickets
 * @author   Joe Dolson
 * @license  GPLv3
 * @link     https://www.joedolson.com/my-tickets/
 */

if ( ! defined( 'ABSPATH' ) ) {
	exit;
} // Exit if accessed directly.

/**
 * Submits a cart update request from AJAX when cart is modified from Cart page.
 *
 * @uses filter mt_update_cart_field_handler
 */
function mt_ajax_cart() {
	// verify nonce.
	if ( ! check_ajax_referer( 'mt-ajax-cart-nonce', 'security', false ) ) {
		echo 0;
		die;
	}
	if ( 'mt_ajax_cart' === $_REQUEST['action'] ) {
		$post = map_deep( $_REQUEST['data'], 'sanitize_text_field' );
		$post = array(
			$post['mt_event_id'] => array(
				$post['mt_event_type'] => array(
					'count' => $post['mt_event_tickets'],
				),
			),
		);
		// generate and submit cart data.
		$saved   = mt_update_cart( $post );
		$saved   = apply_filters( 'mt_update_cart_field_handler', $saved, $post );
		$success = wp_json_encode(
			array(
				'success'  => 1,
				'response' => __( 'Cart updated', 'my-tickets' ),
			)
		);
		$failure = wp_json_encode(
			array(
				'success'  => 0,
				'response' => __( 'Cart not updated', 'my-tickets' ),
			)
		);
		echo ( $saved ) ? $success : $failure;
		die;
	}
}
add_action( 'wp_ajax_mt_ajax_cart', 'mt_ajax_cart' );
add_action( 'wp_ajax_nopriv_mt_ajax_cart', 'mt_ajax_cart' );

/**
 * Submit a cart update request from AJAX when add_to_cart button used from event
 * Submits an address update event on save_address action from purchase process
 *
 * @uses filter mt_add_to_cart_ajax_field_handler
 * @uses mt_ajax_updated_success
 * @uses mt_ajax_updated_unchanged
 *
 * @uses mt_save_address_success
 * @uses mt_save_address_failure
 */
function mt_ajax_handler() {
	// verify nonce.
	if ( ! check_ajax_referer( 'mt-cart-nonce', 'security', false ) ) {
		wp_send_json(
			array(
				'response' => __( 'Invalid security response.', 'my-tickets' ),
				'saved'    => false,
			)
		);
	}
	if ( 'add_to_cart' === $_REQUEST['function'] ) {
		parse_str( $_REQUEST['data'], $data );
		$data = map_deep( $data, 'sanitize_text_field' );
		// reformat request data to multidimensional array.
		$cart = mt_get_cart();
		$lock = 'mt_add_to_cart_lock_' . sanitize_text_field( $_REQUEST['mt-cart-nonce'] );
		if ( get_transient( $lock ) ) {
			$return = array(
				'response' => esc_html__( 'Another transaction is currently processing. Please try again shortly.', 'my-tickets' ),
				'success'  => 0,
			);
			wp_send_json( $return );
		}
		set_transient( $lock, 1, 5 );

		foreach ( $data as $k => $d ) {
			if ( 'mt_tickets' === $k ) {
				foreach ( $d as $n => $value ) {
					if ( $cart ) {
						$data[ $k ][ $n ] = array(
							'count' => $value,
						);
					} else {
						$data[ $k ][ $n ] = $value;
					}
				}
			}
		}
		$submit = $data;

		// generate and submit cart data.
		$save = array();
		if ( isset( $submit['mt_tickets'] ) ) {
			$modified      = false;
			$modified_type = '';
			foreach ( $submit['mt_tickets'] as $type => $count ) {
				$count = is_array( $count ) ? $count[0] : (int) $count;
				/**
				 * Documented in `mt-add-to-cart.php`.
				 */
				$registration      = get_post_meta( $submit['mt_event_id'], '_mt_registration_options', true );
				$default_available = apply_filters( 'mt_default_available', 100, $registration );
				if ( 'general' === $registration['counting_method'] ) {
					$available_count = $default_available;
				} else {
					$available       = mt_check_inventory( $submit['mt_event_id'], $type );
					$available_count = ( $available ) ? $available['available'] : 0;
				}
				$append = '';
				if ( $count > $available_count ) {
					// Set to max available if requested greater than available.
					$submit['mt_tickets'][ $type ] = $available_count;
					$modified                      = true;
					$modified_type                 = ( 0 === $available_count ) ? 'soldout' : 'changed';
				}
			}
			$save = array(
				$submit['mt_event_id'] => $submit['mt_tickets'],
				'mt_event_id'          => $submit['mt_event_id'],
				'mt_tickets'           => $submit['mt_tickets'],
			);
		}

		$saved = mt_update_cart( $save );
		/**
		 * Filter submitted data after cart update.
		 *
		 * @hook mt_add_to_cart_ajax_field_handler
		 *
		 * @param {array} $saved Array containing a `success` and `cart` element.
		 * @param {array} $submit Array of data submitted from form.
		 *
		 * @return {array}
		 */
		$saved = apply_filters( 'mt_add_to_cart_ajax_field_handler', $saved, $submit );
		$url   = mt_get_cart_url();
		if ( $modified ) {
			$append = ( 'changed' === $modified_type ) ? __( 'Some tickets are no longer available, and were removed from your order. Please review your purchase carefully!', 'my-tickets' ) : __( 'There are no longer tickets available for this event.', 'my-tickets' );
			$append = ' ' . $append;
		}
		if ( 1 === (int) $saved['success'] ) {
			// Translators: Cart URL.
			$message  = ( 'soldout' === $modified_type ) ? __( 'Your cart is updated.', 'my-tickets' ) : sprintf( __( "Your cart is updated. &lt;a href='%s'>Checkout&lt;/a>", 'my-tickets' ), $url );
			$response = apply_filters( 'mt_ajax_updated_success', $message . $append );
		} else {
			// Translators: Cart URL.
			$response = apply_filters( 'mt_ajax_updated_unchanged', sprintf( __( "Cart not changed. &lt;a href='%s'>Checkout&lt;/a>", 'my-tickets' ), $url ) ) . $append;
		}
		$return = array(
			'response' => $response,
			'success'  => $saved['success'],
			'count'    => mt_count_cart( $saved['cart'] ),
			'total'    => mt_total_cart( $saved['cart'] ),
			'event_id' => $submit['mt_event_id'],
			'data'     => $count,
		);
		delete_transient( $lock );
		wp_send_json( $return );
	}
	if ( 'save_address' === $_REQUEST['function'] ) {
		$post         = array_map( 'sanitize_text_field', $_REQUEST['data'] );
		$current_user = wp_get_current_user();
		$saved        = update_user_meta( $current_user->ID, '_mt_shipping_address', $post );
		$response     = array();
		if ( $saved ) {
			$response['response'] = apply_filters( 'mt_save_address_success', __( 'Address updated.', 'my-tickets' ) );
		} else {
			$response['response'] = apply_filters( 'mt_save_address_failure', __( 'Address not updated.', 'my-tickets' ) );
		}
		wp_send_json( $response );
	}
	if ( 'extend_cart' === $_REQUEST['function'] ) {
		$extend   = mt_extend_expiration();
		$response = array(
			'response' => __( 'Extension failed.', 'my-tickets' ),
		);
		if ( $extend ) {
			$response = array(
				'response' => __( 'Cart expiration extended', 'my-tickets' ),
			);
		}
		wp_send_json( $response );
	}
}
add_action( 'wp_ajax_mt_ajax_handler', 'mt_ajax_handler' );
add_action( 'wp_ajax_nopriv_mt_ajax_handler', 'mt_ajax_handler' );

/**
 * AJAX load a ticket model set.
 */
function mt_ajax_load_model() {
	// verify nonce.
	if ( ! check_ajax_referer( 'mt-load-model', 'security', false ) ) {
		wp_send_json(
			array(
				'response' => __( 'Invalid security response.', 'my-tickets' ),
				'form'     => '',
			)
		);
	}
	$model    = ( in_array( $_REQUEST['model'], array( 'continuous', 'discrete', 'event' ), true ) ) ? sanitize_key( $_REQUEST['model'] ) : false;
	$event_id = absint( $_REQUEST['event_id'] );
	$data     = isset( $_REQUEST['event'] ) ? map_deep( json_decode( $_REQUEST['event'] ), 'sanitize_text_field' ) : array();
	$form     = mt_get_registration_fields( '', $event_id, $data, 'admin', $model );
	wp_send_json(
		array(
			'form' => $form,
		)
	);
}
add_action( 'wp_ajax_mt_ajax_load_model', 'mt_ajax_load_model' );
add_action( 'wp_ajax_nopriv_mt_ajax_load_model', 'mt_ajax_load_model' );
</code></pre>
        </article>
    </section>




	</main>
    <footer>
		<a href="https://docs.joedolson.com/my-tickets">My Tickets User Documentation</a> &bull;
		<a href="https://github.com/joedolson/my-tickets/">My Tickets on GitHub</a> &bull;
		<a href="https://www.joedolson.com/my-tickets/add-ons/">Buy My Tickets Premium Add-ons</a>
	</footer>

	
</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Actions</h3><ul><li><a href="mt_after_insert_payment.html">mt_after_insert_payment</a></li><li><a href="mt_after_remaining_text.html">mt_after_remaining_text</a></li><li><a href="mt_purchase_completed.html">mt_purchase_completed</a></li><li><a href="mt_save_custom_field.html">mt_save_custom_field</a></li><li><a href="mt_save_payment_fields.html">mt_save_payment_fields</a></li><li><a href="mt_setup_gateways.html">mt_setup_gateways</a></li><li><a href="mt_successful_payment.html">mt_successful_payment</a></li><li><a href="mt_ticket_handling_price.html">mt_ticket_handling_price</a></li><li><a href="mt_ticket_sales_closed.html">mt_ticket_sales_closed</a></li><li><a href="mt_ticket_settings.html">mt_ticket_settings</a></li><li><a href="mt_ticket_type_close_sales.html">mt_ticket_type_close_sales</a></li></ul><h3>Filters</h3><ul><li><a href="mc_event_registration_form.html">mc_event_registration_form</a></li><li><a href="mt_add_to_cart_ajax_field_handler.html">mt_add_to_cart_ajax_field_handler</a></li><li><a href="mt_add_to_cart_fields.html">mt_add_to_cart_fields</a></li><li><a href="mt_add_to_cart_hidden_fields.html">mt_add_to_cart_hidden_fields</a></li><li><a href="mt_add_to_cart_input.html">mt_add_to_cart_input</a></li><li><a href="mt_admin_only_ticket.html">mt_admin_only_ticket</a></li><li><a href="mt_apply_custom_field_rules.html">mt_apply_custom_field_rules</a></li><li><a href="mt_cart_custom_fields.html">mt_cart_custom_fields</a></li><li><a href="mt_cart_date_format.html">mt_cart_date_format</a></li><li><a href="mt_cart_default_value.html">mt_cart_default_value</a></li><li><a href="mt_cart_purchase_date.html">mt_cart_purchase_date</a></li><li><a href="mt_cart_time_format.html">mt_cart_time_format</a></li><li><a href="mt_closure_body.html">mt_closure_body</a></li><li><a href="mt_closure_recipient.html">mt_closure_recipient</a></li><li><a href="mt_closure_subject.html">mt_closure_subject</a></li><li><a href="mt_confirmed_transaction.html">mt_confirmed_transaction</a></li><li><a href="mt_confirmed_transaction_before.html">mt_confirmed_transaction_before</a></li><li><a href="mt_create_location_object.html">mt_create_location_object</a></li><li><a href="mt_currencies.html">mt_currencies</a></li><li><a href="mt_custom_data_fields.html">mt_custom_data_fields</a></li><li><a href="mt_custom_display_field.html">mt_custom_display_field</a></li><li><a href="mt_custom_event_limit.html">mt_custom_event_limit</a></li><li><a href="mt_custom_fields.html">mt_custom_fields</a></li><li><a href="mt_datepicker_html.html">mt_datepicker_html</a></li><li><a href="mt_default_available.html">mt_default_available</a></li><li><a href="mt_default_report_start_date.html">mt_default_report_start_date</a></li><li><a href="mt_default_ticketed_events.html">mt_default_ticketed_events</a></li><li><a href="mt_expiration_window.html">mt_expiration_window</a></li><li><a href="mt_extra_label.html">mt_extra_label</a></li><li><a href="mt_field_parameters.html">mt_field_parameters</a></li><li><a href="mt_filter_payment_data.html">mt_filter_payment_data</a></li><li><a href="mt_format_report_field.html">mt_format_report_field</a></li><li><a href="mt_get_event_link.html">mt_get_event_link</a></li><li><a href="mt_get_events_count.html">mt_get_events_count</a></li><li><a href="mt_get_ticket_ids_query.html">mt_get_ticket_ids_query</a></li><li><a href="mt_handling_total.html">mt_handling_total</a></li><li><a href="mt_hcard.html">mt_hcard</a></li><li><a href="mt_header_columns.html">mt_header_columns</a></li><li><a href="mt_html_email_footer.html">mt_html_email_footer</a></li><li><a href="mt_html_email_h1_styles.html">mt_html_email_h1_styles</a></li><li><a href="mt_html_email_header.html">mt_html_email_header</a></li><li><a href="mt_html_email_wrapper_styles.html">mt_html_email_wrapper_styles</a></li><li><a href="mt_import_gateways.html">mt_import_gateways</a></li><li><a href="mt_is_virtual_inventory.html">mt_is_virtual_inventory</a></li><li><a href="mt_link_title.html">mt_link_title</a></li><li><a href="mt_max_sale_per_event.html">mt_max_sale_per_event</a></li><li><a href="mt_money_format.html">mt_money_format</a></li><li><a href="mt_money_format_spacer.html">mt_money_format_spacer</a></li><li><a href="mt_payment_settings_fields.html">mt_payment_settings_fields</a></li><li><a href="mt_payment_update_settings.html">mt_payment_update_settings</a></li><li><a href="mt_price_in_label.html">mt_price_in_label</a></li><li><a href="mt_qrcode_options.html">mt_qrcode_options</a></li><li><a href="mt_redirect.html">mt_redirect</a></li><li><a href="mt_registration_options.html">mt_registration_options</a></li><li><a href="mt_registration_permissions.html">mt_registration_permissions</a></li><li><a href="mt_registration_tickets_options.html">mt_registration_tickets_options</a></li><li><a href="mt_reports_age_limit.html">mt_reports_age_limit</a></li><li><a href="mt_response_messages.html">mt_response_messages</a></li><li><a href="mt_select_events_args.html">mt_select_events_args</a></li><li><a href="mt_settings.html">mt_settings</a></li><li><a href="mt_shipping_countries.html">mt_shipping_countries</a></li><li><a href="mt_show_form_when_soldout.html">mt_show_form_when_soldout</a></li><li><a href="mt_show_in_cart_fields.html">mt_show_in_cart_fields</a></li><li><a href="mt_soldout_body.html">mt_soldout_body</a></li><li><a href="mt_soldout_subject.html">mt_soldout_subject</a></li><li><a href="mt_submit_button_text.html">mt_submit_button_text</a></li><li><a href="mt_the_title.html">mt_the_title</a></li><li><a href="mt_ticket_handling_notice.html">mt_ticket_handling_notice</a></li><li><a href="mt_ticket_price_label.html">mt_ticket_price_label</a></li><li><a href="mt_ticket_sales_close_text.html">mt_ticket_sales_close_text</a></li><li><a href="mt_ticket_sales_closed_content.html">mt_ticket_sales_closed_content</a></li><li><a href="mt_ticket_template_array.html">mt_ticket_template_array</a></li><li><a href="mt_ticket_type.html">mt_ticket_type</a></li><li><a href="mt_ticket_type_sales_closed.html">mt_ticket_type_sales_closed</a></li><li><a href="mt_ticketing_settings_fields.html">mt_ticketing_settings_fields</a></li><li><a href="mt_ticketing_update_settings.html">mt_ticketing_update_settings</a></li><li><a href="mt_tickets_at_boxoffice_content.html">mt_tickets_at_boxoffice_content</a></li><li><a href="mt_tickets_available_discrete_text.html">mt_tickets_available_discrete_text</a></li><li><a href="mt_tickets_close_value.html">mt_tickets_close_value</a></li><li><a href="mt_tickets_remaining_continuous_text.html">mt_tickets_remaining_continuous_text</a></li><li><a href="mt_tickets_soldout_content.html">mt_tickets_soldout_content</a></li><li><a href="mt_tickets_still_remaining_text.html">mt_tickets_still_remaining_text</a></li><li><a href="mt_validity_date_format.html">mt_validity_date_format</a></li><li><a href="mt_validity_options.html">mt_validity_options</a></li><li><a href="mt_virtual_inventory.html">mt_virtual_inventory</a></li></ul>
</nav>

<br class="clear">

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
