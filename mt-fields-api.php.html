<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: mt-fields-api.php - My Tickets Hook Doumentation</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="styles-docs.css?v=0.1.1">
</head>

<body>

<div id="main">

    <header><h1 class="page-title">Source: mt-fields-api.php</h1></header>
	<main>
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>&lt;?php
/**
 * Fields API.
 *
 * @category API
 * @package  My Tickets
 * @author   Joe Dolson
 * @license  GPLv2 or later
 * @link     https://www.joedolson.com/my-tickets/
 */

if ( ! defined( 'ABSPATH' ) ) {
	exit;
} // Exit if accessed directly

add_action( 'init', 'mt_add_actions' );
/**
 * Parent function to insert custom filters.
 */
function mt_add_actions() {
	// adds field to Add to Cart form.
	add_filter( 'mt_add_to_cart_fields', 'mt_custom_field', 10, 2 );
	// Save field data to cookie/user meta for use in cart.
	add_action( 'mt_add_to_cart_ajax_field_handler', 'mt_handle_custom_field', 10, 2 );
	// Display field data in shopping cart.
	add_filter( 'mt_show_in_cart_fields', 'mt_show_custom_field', 10, 6 );
	// Insert submitted data into Payment post meta.
	add_action( 'mt_save_payment_fields', 'mt_insert_custom_field', 10, 3 );
	// Display field data in tickets list.
	add_filter( 'mt_custom_tickets_fields', 'mt_custom_tickets_fields', 10, 4 );
}

/**
 * Get My Tickets custom fields.
 *
 * @param string $context Where is this field being used. Input, cart, ticket, receipt.
 *
 * @return array
 */
function mt_get_custom_fields( $context ) {
	$fields = array();
	/**
	 * Hook to add custom fields.
	 *
	 * @hook mt_custom_fields
	 *
	 * @param {array}  $fields Array of custom fields. Default empty.
	 * @param {string} $context Where is this function being called. Input, cart, ticket, receipt, etc.
	 *
	 * @return {array}
	 */
	$fields = apply_filters( 'mt_custom_fields', $fields, $context );

	return $fields;
}

/**
 * Add custom fields to tickets.
 *
 * @param string $output Field output.
 * @param int    $event_id Event ID.
 * @param int    $payment_id Payment ID.
 * @param string $sep Field separator.
 *
 * @return string
 */
function mt_custom_tickets_fields( $output, $event_id, $payment_id, $sep ) {
	$custom_fields = mt_get_custom_fields( 'tickets' );
	$return        = '';
	$last_value    = '';
	foreach ( $custom_fields as $name => $field ) {
		$data   = get_post_meta( $payment_id, $name );
		$return = apply_filters( 'mt_custom_ticket_display_field', '', $data, $name, $payment_id );
		if ( ! empty( $data ) &amp;&amp; '' === $return ) {

			foreach ( $data as $d ) {
				if ( ! isset( $field['display_callback'] ) ) {
					$display_value = stripslashes( $d[ $name ] );
				} else {
					$display_value = call_user_func( $field['display_callback'], $d[ $name ], 'payment', $field );
				}

				if ( '' !== $display_value &amp;&amp; (string) $d['event_id'] === (string) $event_id ) {
					$added_value = $field['title'] . ' - ' . $display_value;
					if ( $added_value === $last_value ) {
						continue;
					} else {
						$add_value  = apply_filters( 'mt_custom_ticket_format_output', $added_value . $sep, $payment_id, $name );
						$output    .= $add_value;
						$last_value = $added_value;
					}
				}
			}
		}
	}
	$return = ( $return ) ? '&lt;div class="mt-custom-fields">' . $return . '&lt;/div>' : '';

	return $output . $return;
}

/**
 * Check whether defined custom ticket fields should be shown on a given event.
 *
 * @param array $field Field info.
 * @param int   $event_id Event ID.
 *
 * @return bool
 */
function mt_apply_custom_field( $field, $event_id ) {
	$return = false;
	if ( ! isset( $field['context'] ) || 'global' === $field['context'] ) {
		$return = true;
	}
	if ( is_numeric( $field['context'] ) &amp;&amp; (int) $field['context'] === (int) $event_id ) {
		$return = true;
	}
	if ( is_array( $field['context'] ) &amp;&amp; in_array( $event_id, $field['context'], true ) ) {
		$return = true;
	}

	/**
	 * Filter the boolean value that indicates whether a custom field should be shown on an event.
	 *
	 * @hook mt_apply_custom_field_rules
	 *
	 * @param {bool}  $return True to return this field.
	 * @param {array} $field Array of custom field characteristics.
	 * @param {int}   $event_id Event being displayed.
	 *
	 * @return {bool}
	 */
	return apply_filters( 'mt_apply_custom_field_rules', $return, $field, $event_id );
}

/**
 * Process array of custom field definitions to return output HTML.
 *
 * @param array $fields Field data.
 * @param int   $event_id Event ID.
 *
 * @return string
 */
function mt_custom_field( $fields, $event_id ) {
	$custom_fields = mt_get_custom_fields( 'input' );
	$output        = '';
	foreach ( $custom_fields as $name => $field ) {
		$continue = mt_apply_custom_field( $field, $event_id );
		/**
		 * Modify a custom field's characteristics prior to rendering.
		 *
		 * @hook mt_field_parameters
		 *
		 * @param {array} $field Array of field information.
		 * @param {int}   $event_id The event being rendered.
		 *
		 * @return {array}
		 */
		$field = apply_filters( 'mt_field_parameters', $field, $event_id );
		if ( $continue &amp;&amp; is_array( $field ) ) {
			$user_value = esc_attr( stripslashes( mt_get_data( $name . '_' . $event_id ) ) );
			$required   = isset( $field['required'] ) ? ' required' : '';
			$req_label  = isset( $field['required'] ) ? ' &lt;span class="required">' . __( 'Required', 'my-tickets' ) . '&lt;/span>' : '';
			switch ( $field['input_type'] ) {
				case 'text':
				case 'number':
				case 'email':
				case 'url':
				case 'date':
				case 'tel':
					$output = "&lt;input type='" . $field['input_type'] . "' name='$name' id='$name' value='$user_value'$required />";
					break;
				case 'textarea':
					$output = "&lt;textarea rows='6' cols='60' name='$name' id='$name'$required>$user_value&lt;/textarea>";
					break;
				case 'select':
					if ( isset( $field['input_values'] ) ) {
						$output = "&lt;select name='$name' id='$name'$required>";
						foreach ( $field['input_values'] as $value ) {
							$value = esc_attr( stripslashes( $value ) );
							if ( $value === $user_value ) {
								$selected = " selected='selected'";
							} else {
								$selected = '';
							}
							$output .= "&lt;option value='" . esc_attr( stripslashes( $value ) ) . "'$selected>" . $value . "&lt;/option>\n";
						}
						$output .= '&lt;/select>';
					}
					break;
				case 'checkbox':
				case 'radio':
					if ( isset( $field['input_values'] ) ) {
						$value = $field['input_values'];
						if ( '' !== $user_value ) {
							$checked = ' checked="checked"';
						} else {
							$checked = '';
						}
						$output = "&lt;input type='" . $field['input_type'] . "' name='$name' id='$name' value='" . esc_attr( stripslashes( $value ) ) . "'$checked $required />";
					}
					break;
				default:
					$output = "&lt;input type='text' name='$name' id='$name' value='$user_value' $required />";
			}
			$class   = 'mt-' . sanitize_html_class( $field['title'] );
			$fields .= "&lt;div class='mt-ticket-field $class'>&lt;label for='$name'>" . $field['title'] . $req_label . '&lt;/label> ' . $output . '&lt;/div>';
		}
	}

	return $fields;
}

/**
 * Call user functions to sanitize and save custom data with current user's shopping cart.
 *
 * @param mixed $saved data to save.
 * @param array $submit Submitted data.
 *
 * @return mixed
 */
function mt_handle_custom_field( $saved, $submit ) {
	$custom_fields = mt_get_custom_fields( 'sanitize' );
	foreach ( $custom_fields as $name => $field ) {
		if ( isset( $submit[ $name ] ) ) {
			if ( ! isset( $field['sanitize_callback'] ) || ( isset( $field['sanitize_callback'] ) &amp;&amp; ! function_exists( $field['sanitize_callback'] ) ) ) {
				// if no sanitization is provided, we'll prep it for SQL and strip tags.
				if ( is_array( $submit[ $name ] ) ) {
					$sanitized = map_deep( $submit[ $name ], 'sanitize_text_field' );
				} else {
					$sanitized = sanitize_text_field( $submit[ $name ] );
				}
			} else {
				$sanitized = call_user_func( $field['sanitize_callback'], urldecode( $submit[ $name ] ) );
			}
			$event_id = $submit['mt_event_id'];
			mt_save_data( $sanitized, $name . '_' . $event_id );
		}
	}

	return $saved;
}

/**
 * Display saved data in shopping cart and add hidden input field to pass into payment creation.
 *
 * @param string   $content Shopping cart html.
 * @param int      $event_id Event ID.
 * @param int|bool $payment Payment ID if available.
 * @param string   $type Ticket type for this line item.
 * @param int      $count Number of tickets of this type in cart. May change dynamically.
 * @param string   $format Whether we're in the cart or confirmation view.
 *
 * @return string
 */
function mt_show_custom_field( $content, $event_id, $payment, $type, $count, $format ) {
	$custom_fields = mt_get_custom_fields( 'display' );
	$return        = '';
	foreach ( $custom_fields as $name => $field ) {
		$data = mt_get_data( $name . '_' . $event_id );
		if ( ! isset( $field['display_callback'] ) || ( isset( $field['display_callback'] ) &amp;&amp; ! function_exists( $field['display_callback'] ) ) ) {
			$display_value = sanitize_text_field( $data );
		} else {
			$display_value = call_user_func( $field['display_callback'], $data, 'cart', $field );
		}
		$return .= $display_value . "&lt;input type='hidden' name='{$name}[$event_id]' value='" . esc_attr( $data ) . "' />";
	}
	$return = ( $return ) ? '&lt;div class="mt-custom-fields">' . $return . '&lt;/div>' : '';

	return $content . $return;
}

/**
 * Insert post meta data into payment field.
 *
 * @param integer $payment_id Payment ID.
 * @param array   $post POST data.
 * @param array   $purchased Purchase info.
 */
function mt_insert_custom_field( $payment_id, $post, $purchased ) {
	$custom_fields = mt_get_custom_fields( 'save' );
	foreach ( $custom_fields as $name => $field ) {
		if ( isset( $post[ $name ] ) ) {
			foreach ( $post[ $name ] as $event_id => $data ) {
				if ( '' !== $data ) {
					if ( ! isset( $field['sanitize_callback'] ) || ( isset( $field['sanitize_callback'] ) &amp;&amp; ! function_exists( $field['sanitize_callback'] ) ) ) {
						// if no sanitization is provided, we'll prep it for SQL and strip tags.
						$sanitized = sanitize_text_field( $data );
					} else {
						$sanitized = call_user_func( $field['sanitize_callback'], $data );
					}
					$data = array(
						'event_id' => $event_id,
						$name      => $sanitized,
					);
					add_post_meta( $payment_id, $name, $data );
					/**
					 * Execute a custom action when saving custom field data.
					 *
					 * @hook mt_save_custom_field
					 *
					 * @param {int}    $payment_id Payment ID for this purchase.
					 * @param {int}    $event_id Event tickets purchased for.
					 * @param {string} $name Custom field key being saved.
					 * @param {array}  $sanitized Data submitted by user post-sanitization.
					 * @param {array}  $purchased Full purchase data.
					 */
					do_action( 'mt_custom_field_saved', $payment_id, $event_id, $name, $data, $purchased );
				}
			}
		}
	}
}

/**
 * Display custom field in payment post manager.
 *
 * @param string $content Form HTML.
 * @param int    $payment_id Payment ID.
 *
 * @return string
 */
function mt_show_payment_field( $content, $payment_id ) {
	$custom_fields = mt_get_custom_fields( 'admin' );
	$output        = '';
	foreach ( $custom_fields as $name => $field ) {
		$data = get_post_meta( $payment_id, $name );
		/**
		 * Customize the output of custom fields in the admin Payment record.
		 *
		 * @hook mt_custom_display_field
		 *
		 * @param {string} $output_html. Default empty string.
		 * @param {mixed}  $data Saved data from post meta.
		 * @param {string} $name Field name array key.
		 *
		 * @return {string}
		 */
		$return = apply_filters( 'mt_custom_display_field', '', $data, $name );
		if ( '' === $return ) {
			foreach ( $data as $d ) {
				if ( ! isset( $field['display_callback'] ) ) {
					$display_value = stripslashes( $d[ $name ] );
				} else {
					$display_value = call_user_func( $field['display_callback'], $d[ $name ], 'payment', $field );
				}
				if ( '' !== $display_value ) {
					$event_title = get_the_title( $d['event_id'] );
					$output     .= apply_filters( 'mt_custom_data_format_output', "&lt;p>&lt;strong>$event_title&lt;/strong>:&lt;br />$field[title] - $display_value&lt;/p>", $payment_id, $name );
				}
			}
		} else {
			$output .= $return;
		}
	}

	return $content . $output;
}

/**
 * Display custom field on tickets/receipts
 *
 * @param int            $payment_id Payment ID.
 * @param string|boolean $custom_field Custom field data to display.
 *
 * @return string
 */
function mt_show_custom_data( $payment_id, $custom_field = false ) {
	$custom_fields = mt_get_custom_fields( 'receipt' );
	$output        = '';
	foreach ( $custom_fields as $name => $field ) {
		if ( false === $custom_field || $custom_field === $name ) {
			$data = get_post_meta( $payment_id, $name );
			/**
			 * Customize the display of a custom field.
			 *
			 * @hook mt_custom_display_field
			 *
			 * @param {string} $return Return value of the field.
			 * @param {mixed}  $data Value stored in post meta.
			 * @param {string} $name Field name.
			 *
			 * @return {string}
			 */
			$return = apply_filters( 'mt_custom_display_field', '', $data, $name );
			if ( '' === $return ) {
				foreach ( $data as $d ) {
					if ( ! isset( $field['display_callback'] ) ) {
						$display_value = stripslashes( $d[ $name ] );
					} else {
						$display_value = call_user_func( $field['display_callback'], $d[ $name ], 'payment', $field );
					}
					if ( '' !== $display_value ) {
						$event_title = get_the_title( $d['event_id'] );
						$output     .= apply_filters( 'mt_custom_data_format_output', "&lt;p>&lt;strong>$event_title&lt;/strong>:&lt;br />$field[title] - $display_value&lt;/p>", $payment_id, $custom_field );
					}
				}
			} else {
				$output .= $return;
			}
		}
	}

	return $output;
}
</code></pre>
        </article>
    </section>




	</main>
    <footer>
		<a href="https://docs.joedolson.com/my-tickets">My Tickets User Documentation</a> &bull;
		<a href="https://github.com/joedolson/my-tickets/">My Tickets on GitHub</a> &bull;
		<a href="https://www.joedolson.com/my-tickets/add-ons/">Buy My Tickets Premium Add-ons</a>
	</footer>

	
</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Actions</h3><ul><li><a href="mt_after_insert_payment.html">mt_after_insert_payment</a></li><li><a href="mt_after_remaining_text.html">mt_after_remaining_text</a></li><li><a href="mt_purchase_completed.html">mt_purchase_completed</a></li><li><a href="mt_save_custom_field.html">mt_save_custom_field</a></li><li><a href="mt_save_payment_fields.html">mt_save_payment_fields</a></li><li><a href="mt_setup_gateways.html">mt_setup_gateways</a></li><li><a href="mt_successful_payment.html">mt_successful_payment</a></li><li><a href="mt_ticket_handling_price.html">mt_ticket_handling_price</a></li><li><a href="mt_ticket_sales_closed.html">mt_ticket_sales_closed</a></li><li><a href="mt_ticket_settings.html">mt_ticket_settings</a></li><li><a href="mt_ticket_type_close_sales.html">mt_ticket_type_close_sales</a></li></ul><h3>Filters</h3><ul><li><a href="mc_event_registration_form.html">mc_event_registration_form</a></li><li><a href="mt_add_to_cart_ajax_field_handler.html">mt_add_to_cart_ajax_field_handler</a></li><li><a href="mt_add_to_cart_fields.html">mt_add_to_cart_fields</a></li><li><a href="mt_add_to_cart_hidden_fields.html">mt_add_to_cart_hidden_fields</a></li><li><a href="mt_add_to_cart_input.html">mt_add_to_cart_input</a></li><li><a href="mt_admin_only_ticket.html">mt_admin_only_ticket</a></li><li><a href="mt_apply_custom_field_rules.html">mt_apply_custom_field_rules</a></li><li><a href="mt_cart_custom_fields.html">mt_cart_custom_fields</a></li><li><a href="mt_cart_date_format.html">mt_cart_date_format</a></li><li><a href="mt_cart_default_value.html">mt_cart_default_value</a></li><li><a href="mt_cart_purchase_date.html">mt_cart_purchase_date</a></li><li><a href="mt_cart_time_format.html">mt_cart_time_format</a></li><li><a href="mt_closure_body.html">mt_closure_body</a></li><li><a href="mt_closure_recipient.html">mt_closure_recipient</a></li><li><a href="mt_closure_subject.html">mt_closure_subject</a></li><li><a href="mt_confirmed_transaction.html">mt_confirmed_transaction</a></li><li><a href="mt_create_location_object.html">mt_create_location_object</a></li><li><a href="mt_currencies.html">mt_currencies</a></li><li><a href="mt_custom_data_fields.html">mt_custom_data_fields</a></li><li><a href="mt_custom_display_field.html">mt_custom_display_field</a></li><li><a href="mt_custom_event_limit.html">mt_custom_event_limit</a></li><li><a href="mt_custom_fields.html">mt_custom_fields</a></li><li><a href="mt_datepicker_html.html">mt_datepicker_html</a></li><li><a href="mt_default_available.html">mt_default_available</a></li><li><a href="mt_default_report_start_date.html">mt_default_report_start_date</a></li><li><a href="mt_default_ticketed_events.html">mt_default_ticketed_events</a></li><li><a href="mt_expiration_window.html">mt_expiration_window</a></li><li><a href="mt_extra_label.html">mt_extra_label</a></li><li><a href="mt_field_parameters.html">mt_field_parameters</a></li><li><a href="mt_filter_payment_data.html">mt_filter_payment_data</a></li><li><a href="mt_format_report_field.html">mt_format_report_field</a></li><li><a href="mt_get_event_link.html">mt_get_event_link</a></li><li><a href="mt_get_events_count.html">mt_get_events_count</a></li><li><a href="mt_get_ticket_ids_query.html">mt_get_ticket_ids_query</a></li><li><a href="mt_handling_total.html">mt_handling_total</a></li><li><a href="mt_hcard.html">mt_hcard</a></li><li><a href="mt_header_columns.html">mt_header_columns</a></li><li><a href="mt_html_email_footer.html">mt_html_email_footer</a></li><li><a href="mt_html_email_h1_styles.html">mt_html_email_h1_styles</a></li><li><a href="mt_html_email_header.html">mt_html_email_header</a></li><li><a href="mt_html_email_wrapper_styles.html">mt_html_email_wrapper_styles</a></li><li><a href="mt_import_gateways.html">mt_import_gateways</a></li><li><a href="mt_is_virtual_inventory.html">mt_is_virtual_inventory</a></li><li><a href="mt_link_title.html">mt_link_title</a></li><li><a href="mt_max_sale_per_event.html">mt_max_sale_per_event</a></li><li><a href="mt_money_format.html">mt_money_format</a></li><li><a href="mt_money_format_spacer.html">mt_money_format_spacer</a></li><li><a href="mt_payment_settings_fields.html">mt_payment_settings_fields</a></li><li><a href="mt_payment_update_settings.html">mt_payment_update_settings</a></li><li><a href="mt_price_in_label.html">mt_price_in_label</a></li><li><a href="mt_qrcode_options.html">mt_qrcode_options</a></li><li><a href="mt_redirect.html">mt_redirect</a></li><li><a href="mt_registration_options.html">mt_registration_options</a></li><li><a href="mt_registration_permissions.html">mt_registration_permissions</a></li><li><a href="mt_registration_tickets_options.html">mt_registration_tickets_options</a></li><li><a href="mt_reports_age_limit.html">mt_reports_age_limit</a></li><li><a href="mt_select_events_args.html">mt_select_events_args</a></li><li><a href="mt_settings.html">mt_settings</a></li><li><a href="mt_shipping_countries.html">mt_shipping_countries</a></li><li><a href="mt_show_form_when_soldout.html">mt_show_form_when_soldout</a></li><li><a href="mt_show_in_cart_fields.html">mt_show_in_cart_fields</a></li><li><a href="mt_soldout_body.html">mt_soldout_body</a></li><li><a href="mt_soldout_subject.html">mt_soldout_subject</a></li><li><a href="mt_the_title.html">mt_the_title</a></li><li><a href="mt_ticket_handling_notice.html">mt_ticket_handling_notice</a></li><li><a href="mt_ticket_price_label.html">mt_ticket_price_label</a></li><li><a href="mt_ticket_sales_close_text.html">mt_ticket_sales_close_text</a></li><li><a href="mt_ticket_template_array.html">mt_ticket_template_array</a></li><li><a href="mt_ticket_type.html">mt_ticket_type</a></li><li><a href="mt_ticket_type_sales_closed.html">mt_ticket_type_sales_closed</a></li><li><a href="mt_ticketing_settings_fields.html">mt_ticketing_settings_fields</a></li><li><a href="mt_ticketing_update_settings.html">mt_ticketing_update_settings</a></li><li><a href="mt_tickets_available_discrete_text.html">mt_tickets_available_discrete_text</a></li><li><a href="mt_tickets_close_value.html">mt_tickets_close_value</a></li><li><a href="mt_tickets_remaining_continuous_text.html">mt_tickets_remaining_continuous_text</a></li><li><a href="mt_tickets_soldout_content.html">mt_tickets_soldout_content</a></li><li><a href="mt_tickets_still_remaining_text.html">mt_tickets_still_remaining_text</a></li><li><a href="mt_validity_date_format.html">mt_validity_date_format</a></li><li><a href="mt_validity_options.html">mt_validity_options</a></li><li><a href="mt_virtual_inventory.html">mt_virtual_inventory</a></li></ul>
</nav>

<br class="clear">

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
