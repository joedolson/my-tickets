<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: includes/data-utilities.php - My Tickets Hook Doumentation</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="styles-docs.css?v=0.1.1">
</head>

<body>

<div id="main">

    <header><h1 class="page-title">Source: includes/data-utilities.php</h1></header>
	<main>
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>&lt;?php
/**
 * Utilities for saving, deleting, and managing cart data stores.
 *
 * @category Cart
 * @package  My Tickets
 * @author   Joe Dolson
 * @license  GPLv2 or later
 * @link     https://www.joedolson.com/my-tickets/
 */

/**
 * Abstract function for saving user data (cookie or meta). Saves as cookie is not logged in, as user meta if is.
 *
 * @param array  $passed Data passed to save.
 * @param string $type Type of data to save.
 * @param bool   $override Whether to override this.
 *
 * @return bool
 */
function mt_save_data( $passed, $type = 'cart', $override = false ) {
	$type = sanitize_title( $type );
	if ( true === $override ) {
		$save = $passed;
	} else {
		switch ( $type ) {
			case 'cart':
				$save              = mt_get_cart();
				$options           = $passed['options'];
				$event_id          = $passed['event_id'];
				$save[ $event_id ] = $options;
				break;
			case 'payment':
				$save = $passed;
				break;
			default:
				$save = $passed;
		}
	}
	$current_user = wp_get_current_user();
	mt_refresh_cache();
	$expiration = mt_expiration_window();
	if ( is_user_logged_in() ) {
		$data_age = get_user_meta( $current_user->ID, "_mt_user_init_$type", true );
		if ( ! $data_age ) {
			update_user_meta( $current_user->ID, "_mt_user_init_$type", time() + $expiration );
		}
		update_user_meta( $current_user->ID, "_mt_user_$type", $save );

		return true;
	} else {
		$unique_id = mt_get_unique_id();
		if ( get_transient( 'mt_' . $unique_id . '_' . $type ) ) {
			delete_transient( 'mt_' . $unique_id . '_' . $type );
		}
		set_transient( 'mt_' . $unique_id . '_' . $type, $save, time() + $expiration );
		if ( ! get_transient( 'mt_' . $unique_id . '_expiration' ) ) {
			set_transient( 'mt_' . $unique_id . '_expiration', time() + $expiration, time() + $expiration );
		}
		return true;
	}
}

/**
 * Abstract function to delete data. Defaults to delete user's shopping cart.
 *
 * @param string $data Type of data to delete.
 */
function mt_delete_data( $data = 'cart' ) {
	$unique_id = mt_get_unique_id();
	if ( is_user_logged_in() ) {
		$current_user = wp_get_current_user();
		delete_user_meta( $current_user->ID, "_mt_user_$data" );
	}
	if ( $unique_id ) {
		delete_transient( 'mt_' . $unique_id . '_' . $data );
	}
}

/**
 * Abstract function to retrieve data for current user/public user.
 *
 * @param string       $type Type of data.
 * @param bool|integer $user_ID User ID or false if not logged in.
 *
 * @return array|mixed
 */
function mt_get_data( $type, $user_ID = false ) {
	if ( $user_ID ) {
		$data = get_user_meta( $user_ID, "_mt_user_$type", true );
	} else {
		if ( is_user_logged_in() ) {
			$current_user = wp_get_current_user();
			$data_age     = get_user_meta( $current_user->ID, '_mt_user_init_expiration', true );
			if ( ! $data_age ) {
				$expiration = mt_expiration_window();
				update_user_meta( $current_user->ID, '_mt_user_init_expiration', time() + $expiration );
			}
			if ( time() > $data_age ) {
				// Expire user's cart after the data ages out.
				delete_user_meta( $current_user->ID, "_mt_user_$type" );
			}
			$data = get_user_meta( $current_user->ID, "_mt_user_$type", true );
		} else {
			$unique_id = mt_get_unique_id();
			if ( $unique_id ) {
				$data = get_transient( 'mt_' . $unique_id . '_' . $type );
			} else {
				$data = '[]';
			}
			if ( $data ) {
				if ( '' !== $data &amp;&amp; ! is_numeric( $data ) &amp;&amp; ! is_array( $data ) ) {
					// Data could be JSON and needs to be decoded.
					$decoded = json_decode( $data );
					// If it was valid JSON, use the decoded value. Otherwise, use the original.
					if ( JSON_ERROR_NONE === json_last_error() ) {
						$data = $decoded;
					}
				}
			} else {
				$data = false;
			}
		}
	}

	return $data;
}

add_action( 'init', 'mt_set_user_unique_id' );
/**
 * Note: if sitecookiepath doesn't match the site's render location, this won't work.
 * It'll also create a secondary issue where AJAX actions read the sitecookiepath cookie.
 */
function mt_set_user_unique_id() {
	if ( ! defined( 'DOING_CRON' ) ) {
		$unique_id  = mt_get_unique_id();
		$expiration = mt_expiration_window();
		if ( ! $unique_id ) {
			$unique_id = mt_generate_unique_id();
			if ( version_compare( PHP_VERSION, '7.3.0', '>' ) ) {
				// Fix syntax.
				$options = array(
					'expires'  => time() + $expiration,
					'path'     => COOKIEPATH,
					'domain'   => COOKIE_DOMAIN,
					'secure'   => false,
					'httponly' => true,
					'samesite' => 'Lax',
				);
				setcookie( 'mt_unique_id', $unique_id, $options );
			} else {
				setcookie( 'mt_unique_id', $unique_id, time() + $expiration, COOKIEPATH, COOKIE_DOMAIN, false, true );
			}
		}
	}
}

/**
 * Generate a unique ID to track the current cart process.
 *
 * @return string
 */
function mt_generate_unique_id() {
	$length     = 32;
	$characters = '0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz-_';
	$string     = '';
	for ( $p = 0; $p &lt; $length; $p++ ) {
		$string .= $characters[ wp_rand( 0, strlen( $characters ) - 1 ) ];
	}

	return $string;
}

/**
 * Fetch a unique ID if it exists.
 *
 * @return bool|string
 */
function mt_get_unique_id() {
	$unique_id = ( isset( $_COOKIE['mt_unique_id'] ) ) ? sanitize_text_field( $_COOKIE['mt_unique_id'] ) : false;

	return $unique_id;
}

/**
 * Get cart expiration time.
 *
 * @return int Number of seconds cart will last.
 */
function mt_expiration_window() {
	$options    = array_merge( mt_default_settings(), get_option( 'mt_settings', array() ) );
	$expiration = $options['mt_expiration'];
	// Doesn't support less than 10 minutes.
	if ( ! $expiration || (int) $expiration &lt; 600 ) {
		$expiration = WEEK_IN_SECONDS;
	}
	$return = absint( $expiration );
	/**
	 * Filter the length of time data is stored. (Shopping carts, unique IDs).
	 *
	 * @hook mt_expiration_window
	 *
	 * @param {int}    $time Number of seconds before data will expire. Default WEEK_IN_SECONDS.
	 *
	 * @return {int}
	 */
	$expiration = apply_filters( 'mt_expiration_window', $return );

	return $expiration;
}

/**
 * Get cart expiration timestamp.
 */
function mt_get_expiration() {
	$expires_at = 0;
	if ( is_user_logged_in() ) {
		$current_user = wp_get_current_user();
		$expires_at   = get_user_meta( $current_user->ID, '_mt_user_init_expiration', true );
	} else {
		$unique_id = mt_get_unique_id();
		if ( $unique_id ) {
			$expires_at = get_transient( 'mt_' . $unique_id . '_expiration' );
		}
	}

	return absint( $expires_at );
}

/**
 * Check whether a user's cart or payment info is expired at init.
 */
function mt_is_cart_expired() {
	$types = array( 'cart', 'payment', 'offline-payment' );
	if ( is_user_logged_in() ) {
		$current_user = wp_get_current_user();
		foreach ( $types as $type ) {
			$data_age = get_user_meta( $current_user->ID, "_mt_user_init_$type", true );
			if ( time() > $data_age ) {
				// Expire user's cart after the data ages out.
				delete_user_meta( $current_user->ID, "_mt_user_$type" );
			}
		}
	} else {
		$unique_id = mt_get_unique_id();
		if ( $unique_id ) {
			$expiration = get_transient( 'mt_' . $unique_id . '_expiration' );
			if ( time() > $expiration ) {
				delete_transient( 'mt_' . $unique_id . '_expiration' );
				foreach ( $types as $type ) {
					delete_transient( 'mt_' . $unique_id . '_' . $type );
				}
			}
		}
	}
}
add_action( 'init', 'mt_is_cart_expired' );
</code></pre>
        </article>
    </section>




	</main>
    <footer>
		<a href="https://docs.joedolson.com/my-tickets">My Tickets User Documentation</a> &bull;
		<a href="https://github.com/joedolson/my-tickets/">My Tickets on GitHub</a> &bull;
		<a href="https://www.joedolson.com/my-tickets/add-ons/">Buy My Tickets Premium Add-ons</a>
	</footer>

	
</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Actions</h3><ul><li><a href="mt_setup_gateways.html">mt_setup_gateways</a></li><li><a href="mt_ticket_handling_price.html">mt_ticket_handling_price</a></li><li><a href="mt_ticket_sales_closed.html">mt_ticket_sales_closed</a></li><li><a href="mt_ticket_settings.html">mt_ticket_settings</a></li></ul><h3>Filters</h3><ul><li><a href="mc_event_registration_form.html">mc_event_registration_form</a></li><li><a href="mt_add_to_cart_fields.html">mt_add_to_cart_fields</a></li><li><a href="mt_add_to_cart_hidden_fields.html">mt_add_to_cart_hidden_fields</a></li><li><a href="mt_admin_only_ticket.html">mt_admin_only_ticket</a></li><li><a href="mt_cart_purchase_date.html">mt_cart_purchase_date</a></li><li><a href="mt_create_location_object.html">mt_create_location_object</a></li><li><a href="mt_currencies.html">mt_currencies</a></li><li><a href="mt_custom_data_fields.html">mt_custom_data_fields</a></li><li><a href="mt_custom_fields.html">mt_custom_fields</a></li><li><a href="mt_default_available.html">mt_default_available</a></li><li><a href="mt_default_report_start_date.html">mt_default_report_start_date</a></li><li><a href="mt_default_ticketed_events.html">mt_default_ticketed_events</a></li><li><a href="mt_expiration_window.html">mt_expiration_window</a></li><li><a href="mt_extra_label.html">mt_extra_label</a></li><li><a href="mt_filter_payment_data.html">mt_filter_payment_data</a></li><li><a href="mt_format_report_field.html">mt_format_report_field</a></li><li><a href="mt_get_events_count.html">mt_get_events_count</a></li><li><a href="mt_get_ticket_ids_query.html">mt_get_ticket_ids_query</a></li><li><a href="mt_handling_total.html">mt_handling_total</a></li><li><a href="mt_hcard.html">mt_hcard</a></li><li><a href="mt_import_gateways.html">mt_import_gateways</a></li><li><a href="mt_max_sale_per_event.html">mt_max_sale_per_event</a></li><li><a href="mt_money_format_spacer.html">mt_money_format_spacer</a></li><li><a href="mt_payment_settings_fields.html">mt_payment_settings_fields</a></li><li><a href="mt_payment_update_settings.html">mt_payment_update_settings</a></li><li><a href="mt_price_in_label.html">mt_price_in_label</a></li><li><a href="mt_qrcode_options.html">mt_qrcode_options</a></li><li><a href="mt_redirect.html">mt_redirect</a></li><li><a href="mt_registration_options.html">mt_registration_options</a></li><li><a href="mt_registration_permissions.html">mt_registration_permissions</a></li><li><a href="mt_registration_tickets_options.html">mt_registration_tickets_options</a></li><li><a href="mt_settings.html">mt_settings</a></li><li><a href="mt_the_title.html">mt_the_title</a></li><li><a href="mt_ticket_template_array.html">mt_ticket_template_array</a></li><li><a href="mt_ticket_type.html">mt_ticket_type</a></li><li><a href="mt_ticketing_settings_fields.html">mt_ticketing_settings_fields</a></li><li><a href="mt_ticketing_update_settings.html">mt_ticketing_update_settings</a></li><li><a href="mt_tickets_close_value.html">mt_tickets_close_value</a></li><li><a href="mt_tickets_soldout_content.html">mt_tickets_soldout_content</a></li><li><a href="mt_validity_date_format.html">mt_validity_date_format</a></li><li>{mt_shipping_countries}</li></ul>
</nav>

<br class="clear">

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
