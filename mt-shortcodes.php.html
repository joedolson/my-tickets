<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: mt-shortcodes.php - My Tickets Hook Doumentation</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="styles-docs.css?v=0.1.1">
</head>

<body>

<div id="main">

    <header><h1 class="page-title">Source: mt-shortcodes.php</h1></header>
	<main>
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>&lt;?php
/**
 * Shortcodes
 *
 * @category Display
 * @package  My Tickets
 * @author   Joe Dolson
 * @license  GPLv2 or later
 * @link     https://www.joedolson.com/my-tickets/
 */

if ( ! defined( 'ABSPATH' ) ) {
	exit;
} // Exit if accessed directly.

add_shortcode( 'quick-cart', 'my_tickets_short_cart' );
add_filter( 'universal_top_of_header', 'my_tickets_short_cart', 10, 1 );
add_filter( 'milky_way_top_of_header', 'my_tickets_short_cart', 10, 1 );

/**
 * Shortcode to add quick cart to site. Shows current number of tickets and total value plus link to checkout.
 *
 * @return string
 */
function my_tickets_short_cart() {
	$options = mt_get_settings();
	$cart    = mt_get_cart();
	$total   = mt_total_cart( $cart );
	$tickets = mt_count_cart( $cart );
	// Translators: Number of tickets.
	$ticket_text  = apply_filters( 'mt_quick_cart_ticket_text', sprintf( _n( '%s ticket', '%s tickets', $tickets, 'my-tickets' ), "&lt;span class='mt_qc_tickets'>$tickets&lt;/span>" ) );
	$url          = get_permalink( $options['mt_purchase_page'] );
	$symbol_order = $options['symbol_order'];
	if ( 'symbol-first' === $symbol_order ) {
		$currency = "&lt;span class='mt_currency'>" . mt_symbols( $options['mt_currency'] ) . "&lt;/span>&lt;span class='mt_qc_total'>" . number_format( $total, 2 ) . '&lt;/span>';
	} else {
		$currency = "&lt;span class='mt_qc_total'>" . number_format( $total, 2 ) . "&lt;/span> &lt;span class='mt_currency'>" . mt_symbols( $options['mt_currency'] ) . '&lt;/span>';
	}
	// Translators: Checkout URL.
	$checkout = apply_filters( 'mt_quick_cart_checkout', sprintf( __( '&lt;a href="%s">Checkout&lt;/a>', 'my-tickets' ), esc_url( $url ) ) );
	if ( $tickets &lt; 1 &amp;&amp; 'true' === $options['mt_hide_empty_short_cart'] ) {
		return '';
	}
	return "
		&lt;div class='my-tickets mt-quick-cart' aria-live='polite'>" . __( 'In your cart: ', 'my-tickets' ) . "$ticket_text
			&lt;span class='divider'>|&lt;/span> 
			$currency
			&lt;span class='divider'>|&lt;/span> 
			$checkout
		&lt;/div>";
}

/**
 * Shortcode to generate ticketing form. Required attribute: event="event_id"
 *
 * @param array  $atts Shortcode attributes.
 * @param string $content Contained content.
 *
 * @return string
 */
function mt_add_to_cart_form_shortcode( $atts, $content = '' ) {
	$atts = shortcode_atts(
		array(
			'event' => false,
			'view'  => 'calendar',
			'time'  => 'month',
		),
		$atts
	);
	if ( $atts['event'] ) {
		return mt_add_to_cart_form( $content, $atts['event'], $atts['view'], $atts['time'], true );
	}

	return '';
}
add_shortcode( 'ticket', 'mt_add_to_cart_form_shortcode' );

/**
 * Produce a list of featured tickets with a custom template and registration forms.
 *
 * @param array  $atts Shortcode attributes.
 * @param string $content Contained content.
 *
 * @return string
 */
function mt_featured_tickets( $atts, $content = '' ) {
	$grouped = false;
	$atts    = shortcode_atts(
		array(
			'events'   => false,
			'group'    => false,
			'taxonomy' => 'mt-event-group',
			'view'     => 'calendar',
			'time'     => 'month',
			'template' => '&lt;h3>{post_title}: {event_begin format="l, F d"}&lt;/h3>&lt;p>{post_excerpt}&lt;/p>',
		),
		$atts
	);
	if ( $atts['events'] ) {
		$events = explode( ',', $atts['events'] );
	} elseif ( $atts['group'] ) {
		if ( is_string( $atts['group'] ) ) {
			// Gets a group of events by taxonomy term.
			$events = mt_get_events_by_term( $atts['group'], $atts['taxonomy'] );
		}
		if ( is_numeric( $atts['group'] ) ) {
			// Gets a group of events by My Calendar event group ID.
			$events = mt_get_events_by_group_id( $atts['group'] );
		}
		$grouped = true;
	} else {
		/**
		 * Set an array of default event IDs to show in the [tickets] shortcode. Only runs if the 'events' shortcode attribute is false.
		 *
		 * @hook mt_default_ticketed_events
		 *
		 * @param {array} $events Array of event IDs.
		 * @param {array} $atts Shortcode attributes.
		 * @param {string} $content Shortcode contents.
		 *
		 * @return {array}
		 */
		$events = apply_filters( 'mt_default_ticketed_events', array(), $atts, $content );
	}
	$content = '';
	if ( is_array( $events ) &amp;&amp; ! empty( $events ) ) {
		$group = false;
		if ( $grouped ) {
			$count = count( $events );
			$last  = $events[ $count - 1 ];
			$first = $events[0];
			$group = array(
				'first' => $first,
				'last'  => $last,
			);
		}
		foreach ( $events as $event ) {
			$event_data = get_post_meta( $event, '_mc_event_data', true );
			$post       = get_post( $event, ARRAY_A );
			if ( is_array( $post ) &amp;&amp; is_array( $event_data ) ) {
				/**
				 * Filter the data used to draw event templates in the [tickets] shortcode.
				 *
				 * @hook mt_ticket_template_array
				 *
				 * @param {array} $data Merged array of stored event data and post object as array.
				 *
				 * @return {array}
				 */
				$data       = apply_filters( 'mt_ticket_template_array', array_merge( $event_data, $post ) );
				$event_data = "&lt;div class='mt-event-details'>" . mt_draw_template( $data, $atts['template'] ) . '&lt;/div>';
				$content   .= "&lt;div class='mt-event-item'>" . $event_data . mt_add_to_cart_form( '', $event, $atts['view'], $atts['time'], true, $group ) . '&lt;/div>';
			}
		}
	}

	return "&lt;div class='mt-event-list'>" . $content . '&lt;/div>';
}
add_shortcode( 'tickets', 'mt_featured_tickets' );

/**
 * Display the number of tickets remaining for an event.
 *
 * @param array  $atts Shortcode attributes.
 * @param string $content Contained content.
 *
 * @return string
 */
function mt_remaining_tickets( $atts, $content = '' ) {
	$atts     = shortcode_atts(
		array(
			'event'    => false,
			'template' => '&lt;p>{remain} tickets left of {total}&lt;/p>',
		),
		$atts
	);
	$template = $atts['template'];

	if ( ! is_numeric( $atts['event'] ) ) {
		global $post;
		if ( is_object( $post ) ) {
			$event_id = $post->ID;
		} else {
			return $content;
		}
	} else {
		$event_id = (int) $atts['event'];
	}
	$registration = get_post_meta( $event_id, '_mt_registration_options', true );
	if ( is_array( $registration ) ) {
		$pricing      = $registration['prices'];
		$available    = $registration['total'];
		$tickets_data = mt_tickets_left( $pricing, $available );

		return '&lt;div class="mt-remaining-tickets">' . mt_draw_template( $tickets_data, $template ) . '&lt;/div>';
	} else {
		return $content;
	}

	return $content;
}
add_shortcode( 'remaining', 'mt_remaining_tickets' );

/**
 * Insert {register} quicktag into the My Calendar templating array.
 *
 * @param array  $e Array of My Calendar template values.
 * @param object $event My Calendar event object.
 *
 * @return array
 */
function mt_add_shortcode( $e, $event ) {
	$e['register']      = mt_add_to_cart_form( '', $event->event_post );
	$e['ticket_status'] = mt_event_status( $event->event_post );

	return $e;
}
// Add {register} form to My Calendar templating for upcoming events lists, etc.
add_filter( 'mc_filter_shortcodes', 'mt_add_shortcode', 5, 2 );

/**
 * Shortcode to output a user's purchases and tickets.
 *
 * @param array  $atts Array of shortcode attributes.
 * @param string $content Contained content.
 *
 * @return string
 */
function mt_user_purchases( $atts, $content ) {
	$atts   = shortcode_atts(
		array(
			'user_id'    => false,
			'count'      => 10,
			'user_email' => '',
		),
		$atts
	);
	$output = mt_display_payments( $atts['user_id'], $atts['count'], $atts['user_email'] );

	return $output;
}
add_shortcode( 'my-payments', 'mt_user_purchases' );

/**
 * Fetch a user's payment history and output on the front-end.
 *
 * @param int    $user_id User ID.
 * @param int    $count Number of payments to display by default.
 * @param string $user_email User email. If provided, fetch payments by email supplied rather than user ID. Ignores User ID.
 *
 * @return string
 */
function mt_display_payments( $user_id = false, $count = 10, $user_email = '' ) {
	$output = '';
	if ( is_user_logged_in() ) {
		$user  = ( ! $user_id ) ? wp_get_current_user()->ID : $user_id;
		$count = ( ! $count ) ? 10 : absint( $count );
		if ( $user &amp;&amp; ! $user_email ) {
			$payments = get_posts(
				array(
					'post_type'   => 'mt-payments',
					'post_status' => array( 'draft, publish' ),
					'author'      => $user,
					'numberposts' => $count,
				)
			);
		} elseif ( $user_email &amp;&amp; is_email( $user_email ) ) {
			$payments = get_posts(
				array(
					'post_type'   => 'mt-payments',
					'post_status' => array( 'draft', 'publish' ),
					'numberposts' => $count,
					'meta_query'  => array(
						array(
							'key'     => 'email',
							'value'   => $user_email,
							'compare' => '=',
						),
					),
				)
			);
		} else {
			$payments = array();
		}
		if ( ! empty( $payments ) ) {
			$thead = '&lt;table class="widefat mt-payments striped">
						&lt;caption>' . __( 'Your Payments', 'my-tickets' ) . '&lt;/caption>
						&lt;thead>
							&lt;tr>
								&lt;th scope="col">' . __( 'ID', 'my-tickets' ) . '&lt;/th>
								&lt;th scope="col">' . __( 'Name', 'my-tickets' ) . '&lt;/th>
								&lt;th scope="col">' . __( 'Date', 'my-tickets' ) . '&lt;/th>
								&lt;th scope="col">' . __( 'Status', 'my-tickets' ) . '&lt;/th>
								&lt;th scope="col">' . __( 'Details', 'my-tickets' ) . '&lt;/th>
							&lt;/tr>
						&lt;/thead>
						&lt;tbody>';
			$tfoot = '&lt;/tbody>
				&lt;/table>';
			foreach ( $payments as $payment ) {
				$details  = '&lt;div class="mt-payment-details">';
				$details .= mt_payment_data( $payment->ID, array( 'dispute', 'other', 'purchase', 'ticket' ) );
				$details .= '&lt;/div>';
				$classes  = implode( ' ', array( $payment->post_status, sanitize_title( get_post_meta( $payment->ID, '_is_paid', true ) ) ) );
				$output  .= '&lt;tr class="' . $classes . '">
					&lt;td>' . $payment->ID . '&lt;/td>
					&lt;td>' . esc_html( get_the_title( $payment->ID ) ) . '&lt;/td>
					&lt;td>' . get_the_date( 'Y-m-d H:i', $payment->ID ) . '&lt;/td>
					&lt;td>' . mt_get_payment_status( $payment->ID ) . '&lt;/td>
					&lt;td>&lt;button type="button" class="mt-show-payment-details" aria-expanded="false">' . __( 'Payment Details', 'my-tickets' ) . '&lt;/button>' . $details . '&lt;/td>
				&lt;/tr>';
			}
			$output = $thead . $output . $tfoot;
		}
	}

	return $output;
}
</code></pre>
        </article>
    </section>




	</main>
    <footer>
		<a href="https://docs.joedolson.com/my-tickets">My Tickets User Documentation</a> &bull;
		<a href="https://github.com/joedolson/my-tickets/">My Tickets on GitHub</a> &bull;
		<a href="https://www.joedolson.com/my-tickets/add-ons/">Buy My Tickets Premium Add-ons</a>
	</footer>

	
</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Actions</h3><ul><li><a href="mt_setup_gateways.html">mt_setup_gateways</a></li><li><a href="mt_ticket_handling_price.html">mt_ticket_handling_price</a></li><li><a href="mt_ticket_sales_closed.html">mt_ticket_sales_closed</a></li><li><a href="mt_ticket_settings.html">mt_ticket_settings</a></li></ul><h3>Filters</h3><ul><li><a href="mc_event_registration_form.html">mc_event_registration_form</a></li><li><a href="mt_add_to_cart_fields.html">mt_add_to_cart_fields</a></li><li><a href="mt_add_to_cart_hidden_fields.html">mt_add_to_cart_hidden_fields</a></li><li><a href="mt_admin_only_ticket.html">mt_admin_only_ticket</a></li><li><a href="mt_apply_custom_field_rules.html">mt_apply_custom_field_rules</a></li><li><a href="mt_cart_date_format.html">mt_cart_date_format</a></li><li><a href="mt_cart_purchase_date.html">mt_cart_purchase_date</a></li><li><a href="mt_cart_time_format.html">mt_cart_time_format</a></li><li><a href="mt_create_location_object.html">mt_create_location_object</a></li><li><a href="mt_currencies.html">mt_currencies</a></li><li><a href="mt_custom_data_fields.html">mt_custom_data_fields</a></li><li><a href="mt_custom_display_field.html">mt_custom_display_field</a></li><li><a href="mt_custom_fields.html">mt_custom_fields</a></li><li><a href="mt_datepicker_html.html">mt_datepicker_html</a></li><li><a href="mt_default_available.html">mt_default_available</a></li><li><a href="mt_default_report_start_date.html">mt_default_report_start_date</a></li><li><a href="mt_default_ticketed_events.html">mt_default_ticketed_events</a></li><li><a href="mt_expiration_window.html">mt_expiration_window</a></li><li><a href="mt_extra_label.html">mt_extra_label</a></li><li><a href="mt_filter_payment_data.html">mt_filter_payment_data</a></li><li><a href="mt_format_report_field.html">mt_format_report_field</a></li><li><a href="mt_get_events_count.html">mt_get_events_count</a></li><li><a href="mt_get_ticket_ids_query.html">mt_get_ticket_ids_query</a></li><li><a href="mt_handling_total.html">mt_handling_total</a></li><li><a href="mt_hcard.html">mt_hcard</a></li><li><a href="mt_header_columns.html">mt_header_columns</a></li><li><a href="mt_import_gateways.html">mt_import_gateways</a></li><li><a href="mt_is_virtual_inventory.html">mt_is_virtual_inventory</a></li><li><a href="mt_max_sale_per_event.html">mt_max_sale_per_event</a></li><li><a href="mt_money_format_spacer.html">mt_money_format_spacer</a></li><li><a href="mt_payment_settings_fields.html">mt_payment_settings_fields</a></li><li><a href="mt_payment_update_settings.html">mt_payment_update_settings</a></li><li><a href="mt_price_in_label.html">mt_price_in_label</a></li><li><a href="mt_qrcode_options.html">mt_qrcode_options</a></li><li><a href="mt_redirect.html">mt_redirect</a></li><li><a href="mt_registration_options.html">mt_registration_options</a></li><li><a href="mt_registration_permissions.html">mt_registration_permissions</a></li><li><a href="mt_registration_tickets_options.html">mt_registration_tickets_options</a></li><li><a href="mt_settings.html">mt_settings</a></li><li><a href="mt_the_title.html">mt_the_title</a></li><li><a href="mt_ticket_template_array.html">mt_ticket_template_array</a></li><li><a href="mt_ticket_type.html">mt_ticket_type</a></li><li><a href="mt_ticket_type_sales_closed.html">mt_ticket_type_sales_closed</a></li><li><a href="mt_ticketing_settings_fields.html">mt_ticketing_settings_fields</a></li><li><a href="mt_ticketing_update_settings.html">mt_ticketing_update_settings</a></li><li><a href="mt_tickets_close_value.html">mt_tickets_close_value</a></li><li><a href="mt_tickets_soldout_content.html">mt_tickets_soldout_content</a></li><li><a href="mt_validity_date_format.html">mt_validity_date_format</a></li><li><a href="mt_validity_options.html">mt_validity_options</a></li><li>{mt_shipping_countries}</li></ul>
</nav>

<br class="clear">

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
